<!-- index.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¿›é˜¶ç›‘æ§ç³»ç»Ÿ v2.0</title>
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <div class="container">
      <div class="controls">
        <button onclick="makeError()">ç‚¹æˆ‘è§¦å‘ä¸€ä¸ª JS é”™è¯¯</button>
        <button onclick="makeResourceError()">ç‚¹æˆ‘è§¦å‘å›¾ç‰‡ 404 é”™è¯¯</button>
        <button onclick="makePromiseError()">ç‚¹æˆ‘è§¦å‘ Promise é”™è¯¯</button>
        <button onclick="renderDashboard()">âœ¨ åˆ·æ–°å¯è§†åŒ–æŠ¥è¡¨</button>
        <div id="log-list"></div>
      </div>
      <div id="chart-main"></div>
    </div>

    <!-- æ¨¡å—åŒ– -->
    <script type="module">
      import Monitor from './js/monitor/index.js'
      import { renderChart } from './js/visualizer.js'

      // åœ¨è¿™é‡Œå®šä¹‰ï¼šæ”¶åˆ°ç›‘æ§æ•°æ®ååšä»€ä¹ˆ
      const onReportReceived = (data, isHistory) => {
        // 1. æ¸²æŸ“æ—¥å¿—åˆ—è¡¨
        renderLogs(data, isHistory)
        // 2. åˆ·æ–°å›¾è¡¨
        renderChart()
      }

      // å¯åŠ¨æ—¶æŠŠè¿™ä¸ª â€œå†³å®šæƒâ€ ä¼ ç»™ SDK
      Monitor.start({
        onReport: onReportReceived
      })

      function renderLogs(data, isHistory) {
        const list = document.getElementById('log-list')
        if (!list) return

        const item = document.createElement('div')
        item.className = 'error-item'
        // æ ¹æ®ç±»å‹ç»™é¢œè‰²
        const colorMap = {
          é¡µé¢åŠ è½½æ€§èƒ½: '#1890ff',
          JSé”™è¯¯: '#ff4d4f',
          èµ„æºé”™è¯¯: '#faad14',
          Promiseé”™è¯¯: '#722ed1'
        }
        item.style.color = isHistory ? '#999' : colorMap[data.type] || '#ccc'

        const pathStr =
          data.path && data.path.length > 0 ? data.path.join(' -> ') : 'æ— '

        item.innerHTML = `
    ${isHistory ? '[å†å²è®°å½•] ' : ''}[${data.time}] ğŸš¨ ${data.type}<br>
    å†…å®¹: ${data.msg || data.url || ''}<br>
    <b>æ“ä½œè·¯å¾„ï¼š${pathStr}</b>
  `
        const typeClass =
          data.type === 'JSé”™è¯¯'
            ? 'item-js-error'
            : data.type === 'é¡µé¢åŠ è½½æ€§èƒ½'
              ? 'item-perf'
              : data.tag === 'Rage-Click'
                ? 'item-rage'
                : ''
        item.className = `error-item ${typeClass}`

        list.prepend(item)
      }

      // å…¨å±€æŒ‚åœ¨ä¸€ä¸ªå‡½æ•°ç»™æŒ‰é’®ç”¨
      window.renderDashboard = renderChart
      // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
      window.onload = renderChart

      // --- ä¸šåŠ¡ä»£ç ï¼ˆæ•…æ„åˆ¶é€ é”™è¯¯ï¼‰ ---
      window.makeError = function makeError() {
        // è¿™é‡Œæ•…æ„è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„å˜é‡
        console.log(myUndefinedVariable)
      }

      // ä¸šåŠ¡ä»£ç ï¼šè§¦å‘èµ„æºé”™è¯¯
      window.makeResourceError = function makeResourceError() {
        const img = new Image()
        img.style.marginTop = '8px'
        img.style.borderRadius = '8px'
        img.src = ' https://this-is-a-404-image.jpg' // ä¸€ä¸ªä¸å­˜åœ¨çš„å›¾ç‰‡
        document.body.appendChild(img)
      }

      // ä¸šåŠ¡ä»£ç ï¼šè§¦å‘å¼‚æ­¥æŠ¥é”™
      window.makePromiseError = function makePromiseError() {
        return new Promise((resolve, reject) => {
          // æ¨¡æ‹Ÿä¸€ä¸ªå¼‚æ­¥æ“ä½œå¤±è´¥
          reject('æœåŠ¡å™¨è¿”å›ï¼š403 æ— æƒé™')
        })
      }
    </script>
  </body>
</html>
