<!-- index.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¿›é˜¶ç›‘æ§ç³»ç»Ÿ v2.0</title>
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <div class="container">
      <div class="controls">
        <button
          onclick="clearCloudLogs()"
          style="background-color: #ff4d4f; color: #fff"
        >
          ğŸ§¨ æ¸…ç©ºäº‘ç«¯æ•°æ®
        </button>
        <button onclick="makeError()">ç‚¹æˆ‘è§¦å‘ä¸€ä¸ª JS é”™è¯¯</button>
        <button onclick="makeResourceError()">ç‚¹æˆ‘è§¦å‘å›¾ç‰‡ 404 é”™è¯¯</button>
        <button onclick="makePromiseError()">ç‚¹æˆ‘è§¦å‘ Promise é”™è¯¯</button>
        <button onclick="renderDashboard()">âœ¨ åˆ·æ–°å¯è§†åŒ–æŠ¥è¡¨</button>
        <div id="log-list"></div>
      </div>
      <div id="chart-main"></div>
    </div>

    <script>
      async function clearCloudLogs() {
        if (confirm('ç¡®å®šè¦åˆ é™¤äº‘ç«¯æ‰€æœ‰ç›‘æ§è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼')) {
          await fetch('/api/clear-logs')
          location.reload()
        }
      }
    </script>

    <!-- æ¨¡å—åŒ– -->
    <script type="module">
      import Monitor from './js/monitor/index.js'
      import { renderChart } from './js/visualizer.js'

      // åœ¨è¿™é‡Œå®šä¹‰ï¼šæ”¶åˆ°ç›‘æ§æ•°æ®ååšä»€ä¹ˆ
      const onReportReceived = (data, isHistory) => {
        // 1. æ¸²æŸ“æ—¥å¿—åˆ—è¡¨
        renderLogs(data, isHistory)
        // 2. åˆ·æ–°å›¾è¡¨
        renderChart()
      }

      // å¯åŠ¨æ—¶æŠŠè¿™ä¸ª â€œå†³å®šæƒâ€ ä¼ ç»™ SDK
      Monitor.start({
        onReport: onReportReceived
      })
      // index.html é‡Œçš„ renderLogs ç®€åŒ–ç‰ˆ
      function renderLogs(data, isHistory) {
        const list = document.getElementById('log-list')
        const item = document.createElement('div')

        // ç»Ÿä¸€ç®¡ç†ç±»å
        const typeClass =
          data.type === 'JSé”™è¯¯'
            ? 'item-js-error'
            : data.type === 'é¡µé¢åŠ è½½æ€§èƒ½'
              ? 'item-perf'
              : data.tag === 'Rage-Click'
                ? 'item-rage'
                : ''
        const historyClass = isHistory ? 'is-history' : ''

        item.className = `error-item ${typeClass} ${historyClass}`

        const pathStr =
          data.path && data.path.length > 0 ? data.path.join(' -> ') : 'æ— '

        item.innerHTML = `
        [${data.time}] ğŸš¨ ${data.type}<br>
        å†…å®¹: ${data.msg || data.url || ''}<br>
        <small>æ“ä½œè·¯å¾„ï¼š${pathStr}</small>
    `
        list.prepend(item)
      }
      // å…¨å±€æŒ‚åœ¨ä¸€ä¸ªå‡½æ•°ç»™æŒ‰é’®ç”¨
      window.renderDashboard = renderChart
      // åˆå§‹æ¸²æŸ“ä¸€æ¬¡
      window.onload = renderChart

      // --- ä¸šåŠ¡ä»£ç ï¼ˆæ•…æ„åˆ¶é€ é”™è¯¯ï¼‰ ---
      window.makeError = function makeError() {
        // è¿™é‡Œæ•…æ„è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„å˜é‡
        console.log(myUndefinedVariable)
      }

      // ä¸šåŠ¡ä»£ç ï¼šè§¦å‘èµ„æºé”™è¯¯
      window.makeResourceError = function makeResourceError() {
        const img = new Image()
        img.style.marginTop = '8px'
        img.style.borderRadius = '8px'
        img.src = ' https://this-is-a-404-image.jpg' // ä¸€ä¸ªä¸å­˜åœ¨çš„å›¾ç‰‡
        document.body.appendChild(img)
      }

      // ä¸šåŠ¡ä»£ç ï¼šè§¦å‘å¼‚æ­¥æŠ¥é”™
      window.makePromiseError = function makePromiseError() {
        return new Promise((resolve, reject) => {
          // æ¨¡æ‹Ÿä¸€ä¸ªå¼‚æ­¥æ“ä½œå¤±è´¥
          reject('æœåŠ¡å™¨è¿”å›ï¼š403 æ— æƒé™')
        })
      }
    </script>
  </body>
</html>
